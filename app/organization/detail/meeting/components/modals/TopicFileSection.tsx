'use client';

import { useState, useEffect } from 'react';
import { getTopicImagePaths, saveTopicFile, deleteTopicImage, generateDescriptionForExistingImage, updateTopicFileDescription } from '@/lib/topicImages';

interface TopicFileSectionProps {
  editingTopicId: string | null;
  meetingId: string;
  organizationId: string;
}

export default function TopicFileSection({
  editingTopicId,
  meetingId,
  organizationId,
}: TopicFileSectionProps) {
  const [topicFiles, setTopicFiles] = useState<Array<{ path: string; description?: string; detailedDescription?: string; id?: string; fileName?: string; mimeType?: string; fileSize?: number }>>([]);
  const [isLoadingFiles, setIsLoadingFiles] = useState(false);
  const [uploadingFile, setUploadingFile] = useState(false);
  const [fileDescription, setFileDescription] = useState('');
  const [autoGenerateDescription, setAutoGenerateDescription] = useState(false);
  const [useLocalVLM, setUseLocalVLM] = useState(false);
  const [useDirectLFM2, setUseDirectLFM2] = useState(false);
  const [vlmModel, setVlmModel] = useState<string>('gpt-4o');
  const [availableVlmModels, setAvailableVlmModels] = useState<Array<{ value: string; label: string }>>([]);
  const [loadingVlmModels, setLoadingVlmModels] = useState(false);
  const [generatingDescriptionFor, setGeneratingDescriptionFor] = useState<string | null>(null);
  const [showDeleteFileModal, setShowDeleteFileModal] = useState(false);
  const [fileToDelete, setFileToDelete] = useState<{ path: string; fileName: string } | null>(null);
  const [editingFileDescription, setEditingFileDescription] = useState<{ path: string; description: string; detailedDescription: string } | null>(null);

  // ãƒˆãƒ”ãƒƒã‚¯IDãŒç¢ºå®šã—ãŸã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
  useEffect(() => {
    if (editingTopicId) {
      loadTopicFiles();
    } else {
      setTopicFiles([]);
    }
  }, [editingTopicId]);

  // VLMãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
  useEffect(() => {
    const loadVlmModels = async () => {
      // GPT Visionå¯¾å¿œãƒ¢ãƒ‡ãƒ«
      const gptVisionModels = [
        { value: 'gpt-4o', label: 'GPT-4o (Vision)' },
        { value: 'gpt-4o-mini', label: 'GPT-4o Mini (Vision)' },
        { value: 'gpt-4-turbo', label: 'GPT-4 Turbo (Vision)' },
      ];

      // ãƒ­ãƒ¼ã‚«ãƒ«VLMãƒ¢ãƒ‡ãƒ«ã‚’å–å¾—
      if (useLocalVLM) {
        setLoadingVlmModels(true);
        try {
          const { getAvailableOllamaModels } = await import('@/lib/pageGeneration');
          const localModels = await getAvailableOllamaModels();
          const vlmModels = localModels
            .filter(model => {
              const nameLower = model.name.toLowerCase();
              return nameLower.includes('llava') || 
                     nameLower.includes('vision') ||
                     nameLower.includes('vlm') ||
                     nameLower.includes('bakllava') ||
                     nameLower.includes('moondream') ||
                     nameLower.includes('lfm2') ||
                     nameLower.includes('lfm');
            })
            .map(model => ({ value: model.name, label: model.name }));
          
          setAvailableVlmModels(vlmModels.length > 0 ? vlmModels : [{ value: 'llava:latest', label: 'llava:latest' }]);
        } catch (error) {
          console.error('ãƒ­ãƒ¼ã‚«ãƒ«VLMãƒ¢ãƒ‡ãƒ«ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          setAvailableVlmModels([{ value: 'llava:latest', label: 'llava:latest' }]);
        } finally {
          setLoadingVlmModels(false);
        }
      } else {
        setAvailableVlmModels(gptVisionModels);
      }
    };

    loadVlmModels();
  }, [useLocalVLM]);

  // ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ã‚’è¨­å®š
  useEffect(() => {
    if (useLocalVLM) {
      // ãƒ­ãƒ¼ã‚«ãƒ«VLMã®å ´åˆã€æœ€åˆã®ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ
      if (availableVlmModels.length > 0) {
        setVlmModel(availableVlmModels[0].value);
      } else {
        setVlmModel('llava:latest');
      }
    } else {
      // GPT Visionã®å ´åˆ
      setVlmModel('gpt-4o');
    }
  }, [useLocalVLM, availableVlmModels]);

  const loadTopicFiles = async () => {
    if (!editingTopicId || !meetingId) return;
    setIsLoadingFiles(true);
    try {
      const files = await getTopicImagePaths(editingTopicId, meetingId);
      console.log('èª­ã¿è¾¼ã‚“ã ãƒ•ã‚¡ã‚¤ãƒ«:', files); // ãƒ‡ãƒãƒƒã‚°ç”¨
      setTopicFiles(files);
    } catch (error) {
      console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    } finally {
      setIsLoadingFiles(false);
    }
  };

  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file || !editingTopicId || !meetingId) return;

    setUploadingFile(true);
    try {
      const result = await saveTopicFile(
        organizationId,
        editingTopicId,
        meetingId,
        file,
        fileDescription.trim() || undefined,
        autoGenerateDescription,
        useLocalVLM,
        vlmModel,
        useDirectLFM2,
        editingTopicId
      );

      if (result.success) {
        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
        await loadTopicFiles();
        
        // è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸèª¬æ˜ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤ºï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆã®ã¿ã€ãƒ•ã‚©ãƒ¼ãƒ ã«ã¯æ®‹ã•ãªã„ï¼‰
        if (result.generatedDescription) {
          const detailMsg = result.generatedDetailedDescription 
            ? `\n\nè©³ç´°è§£èª¬:\n${result.generatedDetailedDescription}`
            : '';
          alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚\n\nè‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸèª¬æ˜ï¼ˆRAGæ¤œç´¢ç”¨ï¼‰:\n${result.generatedDescription}${detailMsg}`);
        } else {
          alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
        }
        
        // èª¬æ˜æ–‡å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ï¼ˆæ¬¡ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã«ï¼‰
        setFileDescription('');
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®ãƒªã‚»ãƒƒãƒˆ
        event.target.value = '';
      } else {
        alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error}`);
      }
    } catch (error: any) {
      console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
      alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
    } finally {
      setUploadingFile(false);
    }
  };

  const handleDeleteFileClick = (filePath: string) => {
    const fileName = filePath.split('/').pop() || filePath;
    setFileToDelete({ path: filePath, fileName });
    setShowDeleteFileModal(true);
  };

  const handleConfirmDeleteFile = async () => {
    if (!fileToDelete || !editingTopicId || !meetingId) return;

    try {
      await deleteTopicImage(organizationId, editingTopicId, meetingId, fileToDelete.path);
      await loadTopicFiles();
      setShowDeleteFileModal(false);
      setFileToDelete(null);
      alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
    } catch (error: any) {
      console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
    }
  };

  const handleCancelDeleteFile = () => {
    setShowDeleteFileModal(false);
    setFileToDelete(null);
  };

  const handleGenerateDescription = async (filePath: string) => {
    if (!editingTopicId || !meetingId) return;

    setGeneratingDescriptionFor(filePath);
    try {
      const result = await generateDescriptionForExistingImage(
        organizationId,
        editingTopicId,
        meetingId,
        filePath,
        useLocalVLM,
        vlmModel,
        useDirectLFM2
      );

      if (result.success && result.description) {
        // è©³ç´°è§£èª¬ã‚‚å–å¾—ã—ã¦è¡¨ç¤º
        const files = await getTopicImagePaths(editingTopicId, meetingId);
        const fileInfo = files.find(f => f.path === filePath);
        const detailMsg = fileInfo?.detailedDescription 
          ? `\n\nè©³ç´°è§£èª¬:\n${fileInfo.detailedDescription}`
          : '';
        alert(`èª¬æ˜ã‚’ç”Ÿæˆã—ã¾ã—ãŸ:\n\nèª¬æ˜æ–‡ï¼ˆRAGæ¤œç´¢ç”¨ï¼‰:\n${result.description}${detailMsg}`);
        await loadTopicFiles(); // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
      } else {
        alert(`èª¬æ˜ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
      }
    } catch (error: any) {
      console.error('èª¬æ˜ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
      alert(`èª¬æ˜ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
    } finally {
      setGeneratingDescriptionFor(null);
    }
  };

  const handleOpenFile = async (filePath: string) => {
    try {
      // Tauriç’°å¢ƒã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
      const isTauri = typeof window !== 'undefined' && '__TAURI__' in window;
      if (isTauri) {
        // Rustã‚³ãƒãƒ³ãƒ‰ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
        const { callTauriCommand } = await import('@/lib/localFirebase');
        const result = await callTauriCommand('open_file', { filePath });
        
        if (result && !result.success) {
          throw new Error(result.error || 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ');
        }
      } else {
        alert('Tauriç’°å¢ƒã§ã®ã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã“ã¨ãŒã§ãã¾ã™ã€‚');
      }
    } catch (error: any) {
      console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã‚¨ãƒ©ãƒ¼:', error);
      alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ: ${error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
    }
  };

  if (!editingTopicId) {
    return null;
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
  const getFileIcon = (name: string) => {
    const ext = name.split('.').pop()?.toLowerCase() || '';
    if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext)) return 'ğŸ“·';
    if (['pdf'].includes(ext)) return 'ğŸ“„';
    if (['xlsx', 'xls'].includes(ext)) return 'ğŸ“Š';
    if (['docx', 'doc'].includes(ext)) return 'ğŸ“';
    if (['txt', 'md'].includes(ext)) return 'ğŸ“ƒ';
    return 'ğŸ“';
  };

  return (
    <>
      <div style={{ marginBottom: '24px', borderTop: '1px solid #e5e7eb', paddingTop: '24px' }}>
        <div style={{ fontSize: '14px', color: '#6B7280', fontWeight: 600, marginBottom: '12px' }}>
          ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«
        </div>
        
        {/* ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */}
        <div style={{ marginBottom: '16px', padding: '16px', backgroundColor: '#F9FAFB', borderRadius: '8px', border: '1px solid #E5E7EB' }}>
          <div style={{ marginBottom: '8px' }}>
            <label style={{ display: 'block', fontSize: '12px', color: '#6B7280', marginBottom: '4px' }}>
              ãƒ•ã‚¡ã‚¤ãƒ«ã®èª¬æ˜æ–‡ï¼ˆRAGæ¤œç´¢ç”¨ï¼‰
            </label>
            <input
              type="text"
              value={fileDescription}
              onChange={(e) => setFileDescription(e.target.value)}
              placeholder="ä¾‹: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ—ã®ã‚°ãƒ©ãƒ•ã€ä¼šè­°è³‡æ–™ã®PDFã€Excelãƒ‡ãƒ¼ã‚¿ãªã©"
              style={{
                width: '100%',
                padding: '8px 12px',
                border: '1px solid #e5e7eb',
                borderRadius: '4px',
                fontSize: '14px',
                boxSizing: 'border-box',
              }}
            />
          </div>
          
          {/* è‡ªå‹•ç”Ÿæˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ */}
          <div style={{ marginBottom: '12px', display: 'flex', flexDirection: 'column', gap: '8px' }}>
            <label style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '13px', color: '#374151', cursor: 'pointer' }}>
              <input
                type="checkbox"
                checked={autoGenerateDescription}
                onChange={(e) => setAutoGenerateDescription(e.target.checked)}
                style={{ cursor: 'pointer' }}
              />
              <span>ç”»åƒã®å ´åˆã€VLMã§èª¬æ˜ã‚’è‡ªå‹•ç”Ÿæˆ</span>
            </label>
            {autoGenerateDescription && (
              <>
                <label style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '12px', color: '#6B7280', cursor: 'pointer', marginLeft: '24px' }}>
                  <input
                    type="checkbox"
                    checked={useLocalVLM}
                    onChange={(e) => setUseLocalVLM(e.target.checked)}
                    style={{ cursor: 'pointer' }}
                  />
                  <span>ãƒ­ãƒ¼ã‚«ãƒ«VLMï¼ˆLiquid AIï¼‰ã‚’ä½¿ç”¨ï¼ˆæœªãƒã‚§ãƒƒã‚¯æ™‚ã¯GPT-4 Visionã‚’ä½¿ç”¨ï¼‰</span>
                </label>
                {loadingVlmModels ? (
                  <div style={{ marginLeft: '24px', fontSize: '12px', color: '#6B7280' }}>
                    ğŸ”„ ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...
                  </div>
                ) : availableVlmModels.length > 0 && (
                  <div style={{ marginLeft: '24px', display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                      <label style={{ fontSize: '12px', color: '#6B7280' }}>
                        VLMãƒ¢ãƒ‡ãƒ«:
                      </label>
                      <select
                        value={vlmModel}
                        onChange={(e) => setVlmModel(e.target.value)}
                        style={{
                          padding: '6px 10px',
                          border: '1px solid #D1D5DB',
                          borderRadius: '4px',
                          fontSize: '12px',
                          backgroundColor: '#FFFFFF',
                          color: '#374151',
                          cursor: 'pointer',
                          minWidth: '200px',
                        }}
                      >
                        {availableVlmModels.map((model) => (
                          <option key={model.value} value={model.value}>
                            {model.label}
                          </option>
                        ))}
                      </select>
                    </div>
                    {(vlmModel.includes('lfm2') || vlmModel.includes('LFM2')) && (
                      <label style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '12px', color: '#6B7280', cursor: 'pointer' }}>
                        <input
                          type="checkbox"
                          checked={useDirectLFM2}
                          onChange={(e) => setUseDirectLFM2(e.target.checked)}
                          style={{ cursor: 'pointer' }}
                        />
                        <span>OllamaçµŒç”±ã§ã¯ãªãç›´æ¥ä½¿ç”¨ï¼ˆPythonã‚¹ã‚¯ãƒªãƒ—ãƒˆçµŒç”±ï¼‰</span>
                      </label>
                    )}
                  </div>
                )}
              </>
            )}
          </div>
          
          <label
            style={{
              display: 'inline-block',
              padding: '8px 16px',
              backgroundColor: uploadingFile ? '#94A3B8' : '#3B82F6',
              color: '#FFFFFF',
              border: 'none',
              borderRadius: '6px',
              fontSize: '14px',
              fontWeight: 500,
              cursor: uploadingFile ? 'not-allowed' : 'pointer',
              transition: 'background-color 0.2s',
            }}
          >
            {uploadingFile ? 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...' : 'ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ'}
            <input
              type="file"
              onChange={handleFileUpload}
              disabled={uploadingFile}
              style={{ display: 'none' }}
            />
          </label>
        </div>
        
        {/* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®è¡¨ç¤º */}
        {isLoadingFiles ? (
          <div style={{ padding: '12px', backgroundColor: '#F9FAFB', borderRadius: '8px', fontSize: '14px', color: '#6B7280' }}>
            èª­ã¿è¾¼ã¿ä¸­...
          </div>
        ) : topicFiles.length > 0 ? (
          <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
            {topicFiles.map((file, index) => {
              const fileName = file.path.split('/').pop() || file.path;
              return (
                <div
                  key={index}
                  style={{
                    position: 'relative',
                    padding: '12px',
                    backgroundColor: '#FFFFFF',
                    borderRadius: '8px',
                    border: '1px solid #E5E7EB',
                    boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
                  }}
                >
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', gap: '12px' }}>
                    <div style={{ flex: 1 }}>
                      <div style={{ marginBottom: '4px' }}>
                        <div
                          onClick={() => handleOpenFile(file.path)}
                          style={{
                            fontSize: '14px',
                            fontWeight: 600,
                            color: '#0066CC',
                            cursor: 'pointer',
                            textDecoration: 'underline',
                            display: 'inline-block',
                            marginBottom: '2px',
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.color = '#0051a8';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.color = '#0066CC';
                          }}
                        >
                          {getFileIcon(fileName)} {file.fileName || fileName}
                        </div>
                        {(file.mimeType || file.fileSize) && (
                          <div style={{ fontSize: '10px', color: '#9CA3AF', marginTop: '2px' }}>
                            {file.mimeType && <span>{file.mimeType}</span>}
                            {file.mimeType && file.fileSize && <span> â€¢ </span>}
                            {file.fileSize && <span>{(file.fileSize / 1024).toFixed(1)} KB</span>}
                          </div>
                        )}
                        {file.id && (
                          <div style={{ fontSize: '10px', color: '#9CA3AF', fontFamily: 'monospace', marginTop: '2px' }}>
                            ID: {file.id}
                          </div>
                        )}
                      </div>
                      {(file.description || file.detailedDescription || editingFileDescription?.path === file.path) && (
                        <div style={{ marginBottom: '8px' }}>
                          {editingFileDescription?.path === file.path ? (
                            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                            <>
                              <div style={{ fontSize: '12px', color: '#6B7280', fontWeight: 600, marginBottom: '4px' }}>
                                ğŸ“ èª¬æ˜æ–‡ï¼ˆRAGæ¤œç´¢ç”¨ï¼‰:
                              </div>
                              <textarea
                                value={editingFileDescription.description}
                                onChange={(e) => setEditingFileDescription({
                                  ...editingFileDescription,
                                  description: e.target.value,
                                })}
                                style={{
                                  width: '100%',
                                  fontSize: '12px',
                                  padding: '6px',
                                  border: '1px solid #D1D5DB',
                                  borderRadius: '4px',
                                  marginBottom: '12px',
                                  resize: 'vertical',
                                  minHeight: '60px',
                                }}
                                placeholder="RAGæ¤œç´¢ç”¨ã®ç°¡æ½”ãªèª¬æ˜æ–‡ã‚’å…¥åŠ›"
                              />
                              <div style={{ fontSize: '12px', color: '#6B7280', fontWeight: 600, marginBottom: '4px' }}>
                                ğŸ“– è©³ç´°è§£èª¬:
                              </div>
                              <textarea
                                value={editingFileDescription.detailedDescription}
                                onChange={(e) => setEditingFileDescription({
                                  ...editingFileDescription,
                                  detailedDescription: e.target.value,
                                })}
                                style={{
                                  width: '100%',
                                  fontSize: '12px',
                                  padding: '6px',
                                  border: '1px solid #D1D5DB',
                                  borderRadius: '4px',
                                  marginBottom: '8px',
                                  resize: 'vertical',
                                  minHeight: '120px',
                                }}
                                placeholder="è©³ç´°ãªè§£èª¬ã‚’å…¥åŠ›"
                              />
                              <div style={{ display: 'flex', gap: '8px', marginTop: '8px' }}>
                                <button
                                  onClick={async () => {
                                    if (!editingTopicId || !meetingId) return;
                                    try {
                                      await updateTopicFileDescription(
                                        organizationId,
                                        editingTopicId,
                                        meetingId,
                                        file.path,
                                        editingFileDescription.description,
                                        editingFileDescription.detailedDescription
                                      );
                                      await loadTopicFiles();
                                      setEditingFileDescription(null);
                                      alert('èª¬æ˜æ–‡ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
                                    } catch (error: any) {
                                      console.error('èª¬æ˜æ–‡ã®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                                      alert(`èª¬æ˜æ–‡ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                                    }
                                  }}
                                  style={{
                                    padding: '6px 12px',
                                    backgroundColor: '#3B82F6',
                                    color: '#FFFFFF',
                                    border: 'none',
                                    borderRadius: '4px',
                                    fontSize: '12px',
                                    cursor: 'pointer',
                                    fontWeight: 500,
                                  }}
                                >
                                  ä¿å­˜
                                </button>
                                <button
                                  onClick={() => setEditingFileDescription(null)}
                                  style={{
                                    padding: '6px 12px',
                                    backgroundColor: '#6B7280',
                                    color: '#FFFFFF',
                                    border: 'none',
                                    borderRadius: '4px',
                                    fontSize: '12px',
                                    cursor: 'pointer',
                                    fontWeight: 500,
                                  }}
                                >
                                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                </button>
                              </div>
                            </>
                          ) : (
                            // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
                            <>
                              {file.description && (
                                <>
                                  <div style={{ fontSize: '12px', color: '#6B7280', fontWeight: 600, marginBottom: '4px' }}>
                                    ğŸ“ èª¬æ˜æ–‡ï¼ˆRAGæ¤œç´¢ç”¨ï¼‰:
                                  </div>
                                  <div style={{ fontSize: '12px', color: '#6B7280', wordBreak: 'break-word', marginBottom: file.detailedDescription ? '12px' : '0' }}>
                                    {file.description}
                                  </div>
                                </>
                              )}
                              {file.detailedDescription && (
                                <>
                                  <div style={{ fontSize: '12px', color: '#6B7280', fontWeight: 600, marginTop: file.description ? '8px' : '0', marginBottom: '4px' }}>
                                    ğŸ“– è©³ç´°è§£èª¬:
                                  </div>
                                  <div style={{ fontSize: '12px', color: '#4B5563', wordBreak: 'break-word', lineHeight: '1.6', padding: '8px', backgroundColor: '#F9FAFB', borderRadius: '4px', border: '1px solid #E5E7EB' }}>
                                    {file.detailedDescription}
                                  </div>
                                </>
                              )}
                            </>
                          )}
                        </div>
                      )}
                      <div style={{ fontSize: '11px', color: '#9CA3AF', fontFamily: 'monospace', wordBreak: 'break-all' }}>
                        {file.path}
                      </div>
                      {file.id && (
                        <div style={{ fontSize: '10px', color: '#9CA3AF', fontFamily: 'monospace', marginTop: '4px' }}>
                          ID: {file.id}
                        </div>
                      )}
                    </div>
                    <div style={{ display: 'flex', gap: '8px', flexShrink: 0 }}>
                      {/* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆã«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º */}
                      {editingFileDescription?.path !== file.path && (
                        <>
                          {/* èª¬æ˜æ–‡ã®ç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³ã®å·¦å´ï¼‰ */}
                          <button
                            onClick={() => setEditingFileDescription({
                              path: file.path,
                              description: file.description || '',
                              detailedDescription: file.detailedDescription || '',
                            })}
                            style={{
                              padding: '6px 12px',
                              backgroundColor: '#F3F4F6',
                              color: '#374151',
                              border: '1px solid #D1D5DB',
                              borderRadius: '6px',
                              fontSize: '12px',
                              cursor: 'pointer',
                              fontWeight: 500,
                            }}
                          >
                            {file.description || file.detailedDescription ? 'ç·¨é›†' : 'èª¬æ˜è¿½åŠ '}
                          </button>
                          {/* ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã®ã¿èª¬æ˜ç”Ÿæˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º */}
                          {/\.(jpg|jpeg|png|gif|webp|svg)$/i.test(fileName) && (
                            <button
                              onClick={() => handleGenerateDescription(file.path)}
                              disabled={generatingDescriptionFor === file.path}
                              style={{
                                padding: '6px 12px',
                                backgroundColor: generatingDescriptionFor === file.path ? '#94A3B8' : '#10B981',
                                color: '#FFFFFF',
                                border: 'none',
                                borderRadius: '6px',
                                fontSize: '12px',
                                cursor: generatingDescriptionFor === file.path ? 'not-allowed' : 'pointer',
                                fontWeight: 500,
                              }}
                            >
                              {generatingDescriptionFor === file.path ? 'ç”Ÿæˆä¸­...' : 'èª¬æ˜ç”Ÿæˆ'}
                            </button>
                          )}
                          {/* å‰Šé™¤ãƒœã‚¿ãƒ³ */}
                          <button
                            onClick={() => handleDeleteFileClick(file.path)}
                            style={{
                              padding: '6px 12px',
                              backgroundColor: '#EF4444',
                              color: '#FFFFFF',
                              border: 'none',
                              borderRadius: '6px',
                              fontSize: '12px',
                              cursor: 'pointer',
                              fontWeight: 500,
                            }}
                          >
                            å‰Šé™¤
                          </button>
                        </>
                      )}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        ) : (
          <div style={{ padding: '12px', backgroundColor: '#F9FAFB', borderRadius: '8px', fontSize: '14px', color: '#9CA3AF', fontStyle: 'italic', textAlign: 'center' }}>
            ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“
          </div>
        )}
      </div>

      {/* ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showDeleteFileModal && fileToDelete && (
        <div
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 3000,
          }}
          onClick={handleCancelDeleteFile}
        >
          <div
            style={{
              backgroundColor: '#FFFFFF',
              borderRadius: '12px',
              padding: '24px',
              maxWidth: '500px',
              width: '90%',
              boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1)',
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <h3 style={{ fontSize: '18px', fontWeight: 600, color: '#1a1a1a', marginBottom: '16px' }}>
              ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ
            </h3>
            <div style={{ marginBottom: '20px' }}>
              <div style={{ fontSize: '14px', color: '#6B7280', marginBottom: '8px' }}>
                ãƒ•ã‚¡ã‚¤ãƒ«å:
              </div>
              <div style={{ fontSize: '14px', fontWeight: 500, color: '#1a1a1a', marginBottom: '12px' }}>
                {fileToDelete.fileName}
              </div>
              <div style={{ fontSize: '12px', color: '#9CA3AF', fontFamily: 'monospace', wordBreak: 'break-all' }}>
                {fileToDelete.path}
              </div>
            </div>
            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '12px' }}>
              <button
                onClick={handleCancelDeleteFile}
                style={{
                  padding: '10px 20px',
                  backgroundColor: '#F3F4F6',
                  color: '#374151',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: 500,
                  cursor: 'pointer',
                }}
              >
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button
                onClick={handleConfirmDeleteFile}
                style={{
                  padding: '10px 20px',
                  backgroundColor: '#EF4444',
                  color: '#FFFFFF',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: 500,
                  cursor: 'pointer',
                }}
              >
                å‰Šé™¤ã™ã‚‹
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
}

