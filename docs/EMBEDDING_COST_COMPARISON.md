# Embedding生成タイミングのコスト比較

## OpenAI埋め込みAPI料金（2024年1月時点）

- **text-embedding-3-small**: **$0.02 per 1M tokens**（入力トークン）
- **text-embedding-3-large**: **$0.13 per 1M tokens**（入力トークン）

現在の実装では `text-embedding-3-small` を使用しています。

## 想定シナリオ

### 1日の使用量想定
- **トピック数**: 10件
- **エンティティ数**: 50件（トピックあたり平均5件）
- **リレーション数**: 30件（トピックあたり平均3件）
- **合計**: 90件の埋め込み生成

### 1件あたりの平均トークン数

#### エンティティ埋め込み
```typescript
// エンティティ埋め込みテキストの例
const combinedText = `
トヨタ自動車
トヨタ自動車
トヨタ自動車

別名: Toyota, トヨタ

役割: 自動車メーカー, 部署: 営業部, 業界: 自動車
`;
```
- **平均トークン数**: 約50-100トークン/エンティティ

#### リレーション埋め込み
```typescript
// リレーション埋め込みテキストの例
const combinedText = `
related-to
related-to
related-to

トヨタ自動車 と 営業部 の関係

取引関係について
`;
```
- **平均トークン数**: 約30-60トークン/リレーション

#### トピック埋め込み
```typescript
// トピック埋め込みテキストの例
const combinedText = `
会議のタイトル

会議の内容...

会議の要約
`;
```
- **平均トークン数**: 約200-500トークン/トピック

## コスト計算

### 前提条件
- エンティティ: 平均75トークン/件
- リレーション: 平均45トークン/件
- トピック: 平均350トークン/件

### 1日の使用量（90件）
- エンティティ: 50件 × 75トークン = **3,750トークン**
- リレーション: 30件 × 45トークン = **1,350トークン**
- トピック: 10件 × 350トークン = **3,500トークン**
- **合計**: **8,600トークン/日**

### 月間使用量
- **8,600トークン/日 × 30日 = 258,000トークン/月**
- **約0.258Mトークン/月**

## 方式別コスト比較

### 方式1: 個別作成時に即時生成（現在の実装）

#### コスト計算
- **APIリクエスト数**: 90リクエスト/日
- **月間リクエスト数**: 2,700リクエスト/月
- **月間トークン数**: 258,000トークン/月
- **月間コスト**: 258,000 ÷ 1,000,000 × $0.02 = **$0.00516/月**

#### 追加コスト要因
- **リトライコスト**: 失敗時の再試行（想定5%）
  - 追加トークン: 258,000 × 0.05 = 12,900トークン
  - 追加コスト: 12,900 ÷ 1,000,000 × $0.02 = $0.000258
- **合計月間コスト**: **約$0.0054/月（約0.8円/月）**

#### 年間コスト
- **約$0.065/年（約10円/年）**

### 方式2: 一括生成ボタンでまとめて生成

#### コスト計算
- **APIリクエスト数**: 1リクエスト/回（バッチ処理）
- **月間リクエスト数**: 30リクエスト/月（1日1回想定）
- **月間トークン数**: 258,000トークン/月（同じ）
- **月間コスト**: 258,000 ÷ 1,000,000 × $0.02 = **$0.00516/月**

#### 追加コスト要因
- **リトライコスト**: 失敗時の再試行（想定5%）
  - 追加トークン: 258,000 × 0.05 = 12,900トークン
  - 追加コスト: 12,900 ÷ 1,000,000 × $0.02 = $0.000258
- **合計月間コスト**: **約$0.0054/月（約0.8円/月）**

#### 年間コスト
- **約$0.065/年（約10円/年）**

## コスト比較結果

| 項目 | 個別生成 | 一括生成 | 差額 |
|------|---------|---------|------|
| **月間コスト** | $0.0054 | $0.0054 | **$0** |
| **年間コスト** | $0.065 | $0.065 | **$0** |
| **APIリクエスト数/月** | 2,700 | 30 | 2,670 |
| **APIレート制限リスク** | 中 | 低 | - |

### 結論

**埋め込み生成のコストは、生成タイミングに関わらず同じです。**

理由：
1. OpenAIの料金は**トークン数**に基づくため、リクエスト数は関係ない
2. 同じデータを生成する限り、トークン数は同じ
3. リクエスト数の違いは、レート制限への影響のみ

## その他の考慮事項

### 1. APIレート制限

#### 個別生成
- **リスク**: 中
- **理由**: 1日90リクエストは通常問題ないが、同時実行が多い場合にレート制限に達する可能性
- **OpenAIのレート制限**: 通常、分あたり数百リクエスト

#### 一括生成
- **リスク**: 低
- **理由**: バッチ処理で制御可能、レート制限を考慮した実装が容易

### 2. パフォーマンス

#### 個別生成
- **保存処理**: 非同期で埋め込み生成を行うため、保存処理自体は高速
- **ユーザー体験**: 保存後すぐに検索可能

#### 一括生成
- **保存処理**: 埋め込み生成を行わないため、保存処理が軽量
- **ユーザー体験**: 生成ボタンを押すまで検索不可

### 3. エラー処理

#### 個別生成
- **エラー検出**: 即座に検出可能
- **エラー対応**: 個別に再試行が必要

#### 一括生成
- **エラー検出**: 一括処理後に検出
- **エラー対応**: 失敗分のみ再生成可能

## 推奨事項

### コスト面
- **どちらの方式でもコストは同じ**
- コスト最適化の観点では、生成タイミングは影響しない

### 実用的な推奨

#### ハイブリッド方式（推奨）
1. **個別生成**: 非同期でバックグラウンド生成（エラーは警告のみ）
2. **一括生成ボタン**: 未生成・失敗分を再生成

**メリット**:
- 即時性: 作成直後に生成を試行
- コスト制御: 失敗時は一括生成で補完
- 柔軟性: ユーザーが再生成を選択可能
- エラー耐性: 個別失敗を一括で補完

#### 実装コスト
- **個別生成**: 既に実装済み
- **一括生成ボタン**: 新規実装が必要（推定: 2-4時間）

## まとめ

| 観点 | 個別生成 | 一括生成 | ハイブリッド |
|------|---------|---------|------------|
| **コスト** | $0.065/年 | $0.065/年 | $0.065/年 |
| **リアルタイム性** | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| **ユーザー体験** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **エラー耐性** | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **実装コスト** | 実装済み | 新規実装 | 新規実装 |

**結論**: コストは同じなので、**ユーザー体験とエラー耐性を重視したハイブリッド方式を推奨**します。

