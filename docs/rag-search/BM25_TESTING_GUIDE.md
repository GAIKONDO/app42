# BM25ハイブリッド検索の動作確認ガイド

> **📋 ステータス**: 動作確認用  
> **📅 作成日**: 2025-12-11  
> **👤 用途**: BM25ハイブリッド検索の動作確認手順

## 概要

このガイドでは、実装したBM25ハイブリッド検索の動作確認方法を説明します。

## 動作確認方法

### 方法1: ブラウザUIでの確認（推奨）

1. **テストページにアクセス**
   - ブラウザで `/rag-search/test-bm25` にアクセス
   - または、開発サーバーを起動して `http://localhost:3020/rag-search/test-bm25` にアクセス

2. **検索クエリを入力**
   - 検索クエリフィールドにテストしたいクエリを入力
   - 例: `トヨタ自動車`, `組織`, `会議` など

3. **ハイブリッド検索設定を調整**
   - 「ベクトル検索を使用」「BM25検索を使用」のチェックボックスで検索方式を選択
   - 重みを調整して検索結果の変化を確認

4. **検索を実行**
   - 「検索」ボタンをクリック
   - ベクトル検索のみとハイブリッド検索の結果を比較

5. **結果を確認**
   - 左側: ベクトル検索のみの結果
   - 右側: ハイブリッド検索の結果
   - パフォーマンス情報（検索時間）を確認

### 方法2: コンソールでの確認

ブラウザの開発者ツールのコンソールで以下のコードを実行:

```typescript
// BM25インデックスの基本動作確認
import { testBM25Index } from '@/lib/knowledgeGraphRAG/__tests__/bm25Search.test';
await testBM25Index();

// エンティティBM25検索の動作確認
import { testEntityBM25Search } from '@/lib/knowledgeGraphRAG/__tests__/bm25Search.test';
await testEntityBM25Search();

// ハイブリッド検索の動作確認
import { testHybridSearch } from '@/lib/knowledgeGraphRAG/__tests__/bm25Search.test';
await testHybridSearch();

// パフォーマンステスト
import { testPerformance } from '@/lib/knowledgeGraphRAG/__tests__/bm25Search.test';
await testPerformance();

// すべてのテストを実行
import { runAllTests } from '@/lib/knowledgeGraphRAG/__tests__/bm25Search.test';
await runAllTests();
```

### 方法3: プログラムからの確認

```typescript
import { searchKnowledgeGraph, DEFAULT_HYBRID_CONFIG } from '@/lib/knowledgeGraphRAG';

// ベクトル検索のみ
const vectorResults = await searchKnowledgeGraph('トヨタ自動車', 10);

// ハイブリッド検索
const hybridResults = await searchKnowledgeGraph(
  'トヨタ自動車',
  10,
  undefined,
  true,
  10000,
  DEFAULT_HYBRID_CONFIG
);

console.log('ベクトル検索結果:', vectorResults);
console.log('ハイブリッド検索結果:', hybridResults);
```

## 確認ポイント

### 1. 基本動作の確認

- [ ] BM25インデックスが正しく構築されるか
- [ ] 検索クエリが正しくトークン化されるか
- [ ] 検索結果が返されるか
- [ ] スコアが正しく計算されるか

### 2. 検索精度の確認

- [ ] 固有名詞を含むクエリで、BM25検索が効果的に機能しているか
- [ ] ハイブリッド検索の結果がベクトル検索と異なるか
- [ ] 検索結果の順位が適切か
- [ ] 関連性の高い結果が上位に表示されるか

### 3. パフォーマンスの確認

- [ ] 初回検索時のインデックス構築時間が許容範囲内か
- [ ] 2回目以降の検索が高速か
- [ ] ハイブリッド検索のオーバーヘッドが許容範囲内か（通常は50-100%増）

### 4. エラーハンドリングの確認

- [ ] エラーが発生した場合、適切に処理されるか
- [ ] フォールバック機能が動作するか
- [ ] エラーメッセージが分かりやすいか

## テストケース

### テストケース1: 固有名詞の検索

**クエリ**: `トヨタ自動車`

**期待結果**:
- BM25検索で「トヨタ」「自動車」を含むエンティティが上位に表示される
- ハイブリッド検索で、ベクトル検索とBM25検索の両方の結果が統合される

### テストケース2: 一般的な概念の検索

**クエリ**: `持続可能な開発`

**期待結果**:
- ベクトル検索が効果的に機能する
- ハイブリッド検索で、ベクトル検索の結果が優先される

### テストケース3: 短いクエリ

**クエリ**: `組織`

**期待結果**:
- BM25検索とベクトル検索の両方が機能する
- 検索結果が適切に統合される

### テストケース4: 空のクエリ

**クエリ**: `` (空文字)

**期待結果**:
- エラーが発生せず、空の結果が返される

### テストケース5: 存在しないキーワード

**クエリ**: `存在しないキーワード12345`

**期待結果**:
- エラーが発生せず、空の結果が返される

## トラブルシューティング

### 問題1: BM25検索が結果を返さない

**原因**:
- `searchableText`カラムが正しく設定されていない
- データが存在しない

**対処法**:
1. SQLiteの`entities`テーブルで`searchableText`カラムを確認
2. データが存在するか確認
3. コンソールログでエラーを確認

### 問題2: 検索速度が遅い

**原因**:
- 初回検索時のインデックス構築
- 大量データの処理

**対処法**:
1. 2回目以降の検索速度を確認（インデックス構築は初回のみ）
2. `organizationId`を指定して検索範囲を限定
3. 検索結果の`limit`を調整

### 問題3: メモリ使用量が増加

**原因**:
- BM25インデックスがメモリ上に保持される

**対処法**:
1. 検索範囲を限定（`organizationId`を指定）
2. 不要な検索を避ける
3. ブラウザのメモリ使用量を監視

### 問題4: 検索結果の順位が不適切

**原因**:
- 重み設定が不適切
- BM25パラメータ（k1, b）が不適切

**対処法**:
1. ハイブリッド検索の重みを調整
2. BM25パラメータを調整（`lib/bm25Search.ts`の`BM25Index`コンストラクタ）

## パフォーマンスベンチマーク

### 期待値

- **初回検索**: 1-5秒（データ量による）
- **2回目以降**: 100-500ms
- **ハイブリッド検索のオーバーヘッド**: 50-100%増

### 測定方法

テストページのパフォーマンスセクションで確認できます。

## 次のステップ

動作確認が完了したら:

1. **パラメータ調整**: BM25パラメータ（k1, b）やハイブリッド検索の重みを調整
2. **フェーズ2の実装**: クエリルーターの実装に進む
3. **本番環境への適用**: 動作確認が完了したら、本番環境で使用

## 関連ドキュメント

- [BM25とルーター実装計画](./BM25_ROUTER_IMPLEMENTATION_PLAN.md) - 実装計画の詳細
- [BM25使用方法](./BM25_USAGE.md) - 使用方法ガイド
- [RAG検索システム評価レポート](./RAG_SEARCH_EVALUATION.md) - 検索システムの評価

