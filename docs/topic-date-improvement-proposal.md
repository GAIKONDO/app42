# トピック日付情報の改善案

## 現状の問題点

1. **`topics`テーブルに`topicDate`（登録日）カラムが存在しない**
   - 登録日は議事録/制度のJSONコンテンツ内にのみ存在
   - データベースで統一管理できない

2. **すべてのトピックが`topics`テーブルに保存されているわけではない**
   - ChromaDBに埋め込みを保存したトピックのみ`topics`テーブルに保存される
   - 議事録/制度のJSONからパースしただけのトピックは`topics`テーブルに存在しない
   - そのため、`createdAt`/`updatedAt`が表示されないトピックがある

3. **日付情報の取得が複雑**
   - `topics`テーブルから取得する場合と、JSONからパースする場合で処理が分かれる
   - データの不整合が発生する可能性がある

## 改善案

### 案1: `topics`テーブルに`topicDate`カラムを追加（推奨）

**概要**: `topics`テーブルに`topicDate`カラムを追加し、トピック保存時に登録日も保存する

**メリット**:
- ✅ 登録日もデータベースで統一管理できる
- ✅ 既存の`createdAt`/`updatedAt`と同様に扱える
- ✅ フィルタリングやソートが容易になる
- ✅ データの整合性が向上

**デメリット**:
- ⚠️ 既存データのマイグレーションが必要
- ⚠️ 既存のトピックには`topicDate`が設定されない（新規保存時のみ）

**実装内容**:
1. データベーススキーマに`topicDate TEXT`カラムを追加
2. `saveTopicEmbedding`関数で`topicDate`も保存
3. Rust側の`save_topic`関数でも`topicDate`を保存
4. `getAllTopicsBatch`で`topics`テーブルから`topicDate`を取得

**影響範囲**:
- `src-tauri/src/database/mod.rs`: スキーマ定義
- `src-tauri/src/db/write_worker.rs`: 保存処理
- `lib/topicEmbeddings.ts`: TypeScript側の保存処理
- `lib/orgApi/topics.ts`: 取得処理

---

### 案2: すべてのトピックを`topics`テーブルに保存

**概要**: トピックが作成された時点で、埋め込みを保存しなくても`topics`テーブルに保存する

**メリット**:
- ✅ すべてのトピックがデータベースで管理される
- ✅ `createdAt`/`updatedAt`が確実に保存される
- ✅ データの一元管理が可能

**デメリット**:
- ⚠️ パフォーマンスへの影響（大量のトピックを保存する必要がある）
- ⚠️ データの重複（議事録/制度のJSONにも存在）
- ⚠️ 既存データの移行が必要

**実装内容**:
1. トピック作成時に`topics`テーブルに保存する処理を追加
2. 埋め込み保存とは別に、基本情報のみを保存
3. 既存のトピックを一括で`topics`テーブルに移行

**影響範囲**:
- トピック作成処理全般
- 議事録/制度の保存処理

---

### 案3: ハイブリッドアプローチ（現状維持 + 改善）

**概要**: 現状の仕組みを維持しつつ、`topics`テーブルに存在するトピックについては日付情報を補完

**メリット**:
- ✅ 既存の仕組みを大きく変更しない
- ✅ 段階的な改善が可能
- ✅ パフォーマンスへの影響が少ない

**デメリット**:
- ⚠️ データの不整合が残る可能性がある
- ⚠️ `topics`テーブルに存在しないトピックは`createdAt`/`updatedAt`が表示されない

**実装内容**:
1. `getAllTopicsBatch`で`topics`テーブルから`createdAt`/`updatedAt`を補完（既に実装済み）
2. `topicDate`は議事録/制度のJSONから取得（現状維持）
3. 表示時に、存在する日付情報のみを表示

**影響範囲**:
- 最小限（既に実装済みの部分を改善）

---

### 案4: 案1 + 案3の組み合わせ（最推奨）

**概要**: `topics`テーブルに`topicDate`カラムを追加し、保存時に登録日も保存。取得時は`topics`テーブルを優先的に参照

**メリット**:
- ✅ 案1と案3の両方のメリットを享受
- ✅ データベースで統一管理できる
- ✅ 既存のトピックにも段階的に適用可能

**デメリット**:
- ⚠️ マイグレーションが必要
- ⚠️ 既存データには`topicDate`が設定されない（新規保存時のみ）

**実装内容**:
1. `topics`テーブルに`topicDate TEXT`カラムを追加
2. `saveTopicEmbedding`関数で`topicDate`も保存
3. Rust側の`save_topic`関数でも`topicDate`を保存
4. `getAllTopicsBatch`で`topics`テーブルから`topicDate`を取得（既に実装済みの補完処理を活用）
5. 表示時に、`topics`テーブルから取得した`topicDate`を優先的に使用

**影響範囲**:
- `src-tauri/src/database/mod.rs`: スキーマ定義とマイグレーション
- `src-tauri/src/db/write_worker.rs`: 保存処理
- `lib/topicEmbeddings.ts`: TypeScript側の保存処理
- `lib/orgApi/topics.ts`: 取得処理（既に実装済み）

---

## 推奨案: 案4（案1 + 案3の組み合わせ）

**理由**:
1. データベースで統一管理できる
2. 既存の補完処理を活用できる
3. 段階的な改善が可能
4. 将来的な拡張性が高い

**実装の優先順位**:
1. **Phase 1**: `topics`テーブルに`topicDate`カラムを追加（マイグレーション）
2. **Phase 2**: 保存処理で`topicDate`も保存するように修正
3. **Phase 3**: 取得処理で`topicDate`を優先的に使用（既に実装済みの補完処理を活用）

**注意点**:
- 既存のトピックには`topicDate`が設定されないため、表示時は議事録/制度のJSONから取得した`topicDate`をフォールバックとして使用
- 新規保存されるトピックから`topicDate`がデータベースに保存される

